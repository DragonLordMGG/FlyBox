<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FlyBox ‚Äî BoxPVP –§–æ—Ä—É–º</title>
  <style>
    :root{
      --bg:#0b0f14; --panel:#121822; --muted:#a8b3cf; --text:#e8eefc;
      --brand:#00d19a; --brand-2:#3fb2ff; --danger:#ff6b6b; --warn:#ffb020;
      --card:#0f1420; --shadow:rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%;}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:linear-gradient(180deg,#0b0f14, #0b0f14 40%, #0d1420);
      color:var(--text);}
    .app{display:grid;grid-template-columns:280px 1fr;min-height:100vh}
    aside{background:linear-gradient(180deg,#0e1521,#0b111b);border-right:1px solid #1d2736;padding:18px 14px;}
    main{padding:20px 24px;}
    header{display:flex;align-items:center;gap:12px;margin-bottom:14px}
    .logo{width:40px;height:40px;border-radius:10px;background:conic-gradient(from 180deg,var(--brand),var(--brand-2));box-shadow:0 6px 20px var(--shadow)}
    h1{font-size:22px;margin:0}
    .subtitle{color:var(--muted);font-size:13px}
    .card{background:linear-gradient(180deg,#0f1624,#0e1522);border:1px solid #1c2636;border-radius:16px;box-shadow:0 10px 32px var(--shadow)}
    .cat{display:flex;flex-direction:column;gap:8px;margin-top:14px}
    .cat button{display:flex;align-items:center;gap:10px;padding:10px 12px;border:1px solid #1c2636;border-radius:12px;background:#0f1420;color:var(--text);cursor:pointer}
    .cat button.active{outline:2px solid rgba(63,178,255,.35);background:linear-gradient(180deg,#121a2b,#0f1523)}
    .cat .badge{margin-left:auto;background:#101a2a;border:1px solid #223147;border-radius:999px;padding:2px 8px;color:var(--muted);font-size:12px}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;margin:16px 0}
    .toolbar input[type="text"]{flex:1;min-width:220px;background:#0e1521;border:1px solid #1d2736;border-radius:12px;padding:10px;color:var(--text)}
    .btn{border:1px solid #1d2736;background:linear-gradient(180deg,#152033,#0f1727);color:var(--text);padding:10px 14px;border-radius:12px;cursor:pointer}
    .btn.brand{background:linear-gradient(180deg,#00d19a,#00a77c);border-color:#00a77c;color:#041810;font-weight:600}
    .btn.ghost{background:#0f1420}
    .btn.danger{background:linear-gradient(180deg,#ff7a7a,#ff5454);border-color:#ff4b4b;color:#230a0a}
    .grid{display:grid;gap:12px}
    .thread{padding:12px 14px}
    .thread h3{margin:0 0 6px 0;font-size:17px}
    .meta{color:var(--muted);font-size:12px}
    .pill{display:inline-flex;gap:6px;align-items:center;border:1px solid #274059;background:#0d1a2a;border-radius:999px;padding:4px 8px;font-size:12px;color:#bcd0ff}
    .stack{display:flex;flex-direction:column;gap:8px}
    .divider{height:1px;background:#1c2636;margin:10px 0}
    .hidden{display:none !important}
    .flex{display:flex;gap:10px;flex-wrap:wrap}
    .spacer{flex:1}
    /* modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);display:flex;align-items:center;justify-content:center;padding:20px}
    .modal{max-width:760px;width:100%}
    .modal .body{padding:16px}
    .modal .header,.modal .footer{padding:12px 16px;border-bottom:1px solid #1c2636}
    .modal .footer{border-top:1px solid #1c2636;border-bottom:none;display:flex;gap:10px;justify-content:flex-end}
    textarea, select{width:100%;background:#0e1521;border:1px solid #1d2736;border-radius:12px;padding:10px;color:var(--text)}
    input[type="text"], input[type="password"], input[type="search"]{width:100%;background:#0e1521;border:1px solid #1d2736;border-radius:12px;padding:10px;color:var(--text)}
    label{font-size:13px;color:#c7d6ff}
    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;font-size:12px;color:#cbd6ee}
    .empty{color:var(--muted);padding:18px;text-align:center}
    .reply{background:#0e1521;border:1px solid #1c2636;border-radius:12px;padding:12px}
    .small{font-size:12px;color:var(--muted)}
    .wrap{max-width:1100px;margin:0 auto}
    .notice{background:#0f1c12;border:1px dashed #1a3b2d;color:#9decc7;border-radius:12px;padding:10px 12px;font-size:13px}
  </style>
</head>
<body>
  <div class="app">
    <aside>
      <header>
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>FlyBox</h1>
          <div class="subtitle">BoxPVP ‚Ä¢ Minecraft —Ñ–æ—Ä—É–º</div>
        </div>
      </header>

      <div class="card" style="padding:12px">
        <div class="stack">
          <div class="pill">IP —Å–µ—Ä–≤–µ—Ä–∞: <span class="kbd">play.flybox.gg</span></div>
          <div class="pill">–í–µ—Ä—Å–∏—è: <span class="kbd">1.20+</span></div>
        </div>
      </div>

      <div class="cat" id="catList"></div>

      <div class="card" style="padding:12px;margin-top:12px">
        <div class="stack">
          <div class="small">–≠–∫—Å–ø–æ—Ä—Ç / –∏–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö (LocalStorage)</div>
          <div class="flex">
            <button class="btn" id="exportBtn">–≠–∫—Å–ø–æ—Ä—Ç</button>
            <input type="file" id="importFile" class="hidden" accept="application/json" />
            <button class="btn" id="importBtn">–ò–º–ø–æ—Ä—Ç</button>
          </div>
          <div class="divider"></div>
          <label for="modKey">–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä—Å–∫–∏–π –∫–ª—é—á (–æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —É–¥–∞–ª–µ–Ω–∏–µ)</label>
          <input type="password" id="modKey" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–ª—é—á‚Ä¶" />
        </div>
      </div>
    </aside>

    <main>
      <div class="wrap">
        <div class="toolbar">
          <input type="search" id="search" placeholder="–ü–æ–∏—Å–∫ —Ç–µ–º –∏ —Å–æ–æ–±—â–µ–Ω–∏–π‚Ä¶" />
          <button class="btn brand" id="newThreadBtn">–ù–æ–≤–∞—è —Ç–µ–º–∞</button>
          <div class="spacer"></div>
          <button class="btn ghost" id="homeBtn">–í—Å–µ —Ç–µ–º—ã</button>
        </div>

        <div id="routeList" class="grid"></div>
        <div id="routeThread" class="hidden"></div>
      </div>
    </main>
  </div>

  <!-- New Thread Modal -->
  <div class="modal-backdrop hidden" id="modalBackdrop" aria-hidden="true">
    <div class="card modal" role="dialog" aria-modal="true">
      <div class="header"><strong>–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é —Ç–µ–º—É</strong></div>
      <div class="body">
        <div class="stack">
          <label>–ó–∞–≥–æ–ª–æ–≤–æ–∫</label>
          <input id="ntTitle" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ü—Ä–∞–≤–∏–ª–∞ —Ä–∞–∑–¥–µ–ª–∞ –ñ–∞–ª–æ–±—ã" />
          <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
          <select id="ntCategory"></select>
          <label>–ê–≤—Ç–æ—Ä</label>
          <input id="ntAuthor" type="text" placeholder="–í–∞—à –Ω–∏–∫ (–Ω–∞–ø—Ä–∏–º–µ—Ä, Steve)" />
          <label>–°–æ–¥–µ—Ä–∂–∏–º–æ–µ</label>
          <textarea id="ntContent" rows="8" placeholder="–û–ø–∏—à–∏—Ç–µ —Ç–µ–º—É‚Ä¶ –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è –ª—ë–≥–∫–∏–µ —Ä–∞–∑–º–µ—Ç–∫–∏: **–∂–∏—Ä–Ω—ã–π**, *–∫—É—Ä—Å–∏–≤*, `–∫–æ–¥`."></textarea>
        </div>
      </div>
      <div class="footer">
        <button class="btn ghost" id="cancelModal">–û—Ç–º–µ–Ω–∞</button>
        <button class="btn brand" id="createThread">–°–æ–∑–¥–∞—Ç—å</button>
      </div>
    </div>
  </div>

  <script>
    // --- Utils ---
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    const uid = () => Math.random().toString(36).slice(2)+Date.now().toString(36);
    const nowISO = () => new Date().toISOString();
    const fmt = iso => new Date(iso).toLocaleString();
    const slugify = s => s.toLowerCase().replace(/[^a-z0-9–∞-—è—ë\s-]/gi,'').trim().replace(/\s+/g,'-');

    // --- Data ---
    const STORAGE_KEY = 'flybox_forum_v1';
    const DEFAULT_CATS = [
      {id: 'news', name:'–ù–æ–≤–æ—Å—Ç–∏ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è', icon:'üì∞'},
      {id: 'rules', name:'–ü—Ä–∞–≤–∏–ª–∞ —Å–µ—Ä–≤–µ—Ä–∞', icon:'‚öñÔ∏è'},
      {id: 'apply', name:'–ó–∞—è–≤–∫–∏ –Ω–∞ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞', icon:'üìù'},
      {id: 'reports', name:'–ñ–∞–ª–æ–±—ã –Ω–∞ –∏–≥—Ä–æ–∫–æ–≤', icon:'üö®'},
      {id: 'bugs', name:'–†–µ–ø–æ—Ä—Ç—ã –±–∞–≥–æ–≤', icon:'üêû'},
      {id: 'trade', name:'–¢–æ—Ä–≥–æ–≤–ª—è', icon:'üí±'},
      {id: 'off', name:'–û—Ñ—Ñ—Ç–æ–ø–∏–∫', icon:'üí¨'}
    ];

    const demoThreads = () => [
      {id:uid(), title:'–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –Ω–∞ FlyBox!', cat:'news', author:'Admin', created:nowISO(), content:'–≠—Ç–æ —Ç–µ—Å—Ç–æ–≤–∞—è –∑–∞–ø–∏—Å—å. –ü—Ä–æ—á–∏—Ç–∞–π—Ç–µ **–ø—Ä–∞–≤–∏–ª–∞** –∏ –Ω–∞—Å–ª–∞–∂–¥–∞–π—Ç–µ—Å—å BoxPVP!', replies:[{id:uid(), author:'Alex', created:nowISO(), content:'–£—Ä–∞! –ö–æ–≥–¥–∞ –≤–∞–π–ø?'},{id:uid(), author:'Admin', created:nowISO(), content:'–ü–ª–∞–Ω–∏—Ä—É–µ–º –Ω–∞ –≤—ã—Ö–æ–¥–Ω—ã—Ö.'}]},
      {id:uid(), title:'[–§–û–†–ú–ê–¢] –ñ–∞–ª–æ–±—ã –Ω–∞ –∏–≥—Ä–æ–∫–æ–≤', cat:'reports', author:'Moderator', created:nowISO(), content:'–®–∞–±–ª–æ–Ω: \n1) –ù–∏–∫ –Ω–∞—Ä—É—à–∏—Ç–µ–ª—è\n2) –î–∞—Ç–∞/–≤—Ä–µ–º—è\n3) –î–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞ (—Å–∫—Ä–∏–Ω/–≤–∏–¥–µ–æ)\n4) –û–ø–∏—Å–∞–Ω–∏–µ —Å–∏—Ç—É–∞—Ü–∏–∏', replies:[]}
    ];

    const load = () => {
      try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)) || null }catch{ return null }
    }
    const save = (data) => localStorage.setItem(STORAGE_KEY, JSON.stringify(data));

    let state = load() || { cats: DEFAULT_CATS, threads: demoThreads(), modKeyHash: null };
    save(state);

    // --- Mod key (client-side only mock) ---
    const setModKey = (key) => { state.modKeyHash = key ? btoa(key) : null; save(state); render(); }
    const isMod = () => {
      const input = $('#modKey').value;
      return input && state.modKeyHash && btoa(input) === state.modKeyHash;
    }

    // --- Rendering ---
    function renderCats(){
      const el = $('#catList');
      el.innerHTML = '';
      state.cats.forEach(c => {
        const btn = document.createElement('button');
        btn.innerHTML = `<span>${c.icon}</span><span>${c.name}</span><span class="badge">${state.threads.filter(t=>t.cat===c.id).length}</span>`;
        btn.onclick = () => navigate(`/category/${c.id}`);
        if(location.hash.includes(`/category/${c.id}`)) btn.classList.add('active');
        el.appendChild(btn);
      })
    }

    function applySearch(list){
      const q = $('#search').value.trim().toLowerCase();
      if(!q) return list;
      return list.filter(t => (
        t.title.toLowerCase().includes(q) ||
        t.content.toLowerCase().includes(q) ||
        t.replies.some(r=>r.content.toLowerCase().includes(q))
      ));
    }

    function renderList(){
      $('#routeThread').classList.add('hidden');
      const listEl = $('#routeList');
      listEl.classList.remove('hidden');
      const parts = location.hash.split('/');
      const catId = parts[2] && parts[1]==='category' ? parts[2] : null;
      let list = state.threads.slice().sort((a,b)=>new Date(b.created)-new Date(a.created));
      if(catId) list = list.filter(t=>t.cat===catId);
      list = applySearch(list);

      if(!list.length){ listEl.innerHTML = `<div class="card empty">–ù–µ—Ç —Ç–µ–º. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º!</div>`; return; }

      listEl.innerHTML = '';
      list.forEach(t => {
        const card = document.createElement('div');
        card.className = 'card thread';
        const cat = state.cats.find(c=>c.id===t.cat);
        card.innerHTML = `
          <h3>${t.title}</h3>
          <div class="meta">–ö–∞—Ç–µ–≥–æ—Ä–∏—è: <span class="pill">${cat.icon} ${cat.name}</span> ‚Ä¢ –ê–≤—Ç–æ—Ä: ${t.author} ‚Ä¢ –°–æ–∑–¥–∞–Ω–æ: ${fmt(t.created)} ‚Ä¢ –û—Ç–≤–µ—Ç–æ–≤: ${t.replies.length}</div>
          <div class="divider"></div>
          <div class="small">${escapeHTML(t.content).slice(0,220)}${t.content.length>220?'‚Ä¶':''}</div>
        `;
        card.onclick = ()=>navigate(`/thread/${t.id}`);
        listEl.appendChild(card);
      });
    }

    function renderThread(id){
      $('#routeList').classList.add('hidden');
      const el = $('#routeThread');
      el.classList.remove('hidden');
      const t = state.threads.find(x=>x.id===id);
      if(!t){ el.innerHTML = `<div class="card empty">–¢–µ–º–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.</div>`; return; }
      const cat = state.cats.find(c=>c.id===t.cat);

      el.innerHTML = `
        <div class="card" style="padding:16px">
          <div class="flex" style="align-items:center">
            <h2 style="margin:0">${t.title}</h2>
            <span class="spacer"></span>
            <span class="pill">${cat.icon} ${cat.name}</span>
          </div>
          <div class="meta" style="margin-top:4px">–ê–≤—Ç–æ—Ä: ${t.author} ‚Ä¢ –°–æ–∑–¥–∞–Ω–æ: ${fmt(t.created)}</div>
          <div class="divider"></div>
          <div>${renderMarkup(t.content)}</div>
          <div class="divider"></div>
          <div class="flex">
            <input id="replyAuthor" type="text" placeholder="–í–∞—à –Ω–∏–∫" style="max-width:240px" />
            <span class="spacer"></span>
            ${isMod()?`<button class="btn danger" id="deleteThread">–£–¥–∞–ª–∏—Ç—å —Ç–µ–º—É</button>`:''}
          </div>
          <textarea id="replyContent" rows="4" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –æ—Ç–≤–µ—Ç‚Ä¶"></textarea>
          <div class="flex" style="justify-content:flex-end">
            <button class="btn brand" id="sendReply">–û—Ç–≤–µ—Ç–∏—Ç—å</button>
          </div>
        </div>

        <div class="grid" style="margin-top:12px">
          ${t.replies.map(r => `
            <div class="reply">
              <div class="flex" style="align-items:center">
                <strong>${r.author}</strong>
                <span class="spacer"></span>
                <span class="small">${fmt(r.created)}</span>
                ${isMod()?`<button class="btn danger" data-rid="${r.id}" style="margin-left:8px">–£–¥–∞–ª–∏—Ç—å</button>`:''}
              </div>
              <div class="divider"></div>
              <div>${renderMarkup(r.content)}</div>
            </div>
          `).join('')}
        </div>
      `;

      // events
      const replyBtn = $('#sendReply');
      replyBtn.onclick = () => {
        const author = $('#replyAuthor').value.trim() || '–ì–æ—Å—Ç—å';
        const content = $('#replyContent').value.trim();
        if(!content) return alert('–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ');
        t.replies.push({id:uid(), author, created:nowISO(), content});
        save(state); renderThread(id);
      }

      if(isMod()){
        const delThread = $('#deleteThread');
        if(delThread) delThread.onclick = () => {
          if(confirm('–£–¥–∞–ª–∏—Ç—å —Ç–µ–º—É –ø–æ–ª–Ω–æ—Å—Ç—å—é?')){
            state.threads = state.threads.filter(x=>x.id!==id);
            save(state); navigate('/');
          }
        }
        $$('#routeThread .reply .btn.danger').forEach(btn => btn.onclick = (e) => {
          const rid = e.currentTarget.getAttribute('data-rid');
          const idx = t.replies.findIndex(x=>x.id===rid);
          if(idx>-1){ t.replies.splice(idx,1); save(state); renderThread(id); }
        });
      }
    }

    // --- Navigation ---
    function navigate(path){ location.hash = '#' + path; }
    window.addEventListener('hashchange', route);

    function route(){
      renderCats();
      const h = location.hash.slice(1);
      if(h.startsWith('/thread/')){ renderThread(h.split('/')[2]); }
      else { renderList(); }
    }

    // --- Modal ---
    const openModal = () => $('#modalBackdrop').classList.remove('hidden');
    const closeModal = () => $('#modalBackdrop').classList.add('hidden');

    function fillCatSelect(){
      const s = $('#ntCategory'); s.innerHTML = '';
      state.cats.forEach(c=>{
        const o = document.createElement('option'); o.value = c.id; o.textContent = `${c.icon} ${c.name}`; s.appendChild(o);
      })
    }

    // --- Markup (very light) ---
    function escapeHTML(s){ return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m])); }
    function renderMarkup(s){
      const e = escapeHTML(s)
        .replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>')
        .replace(/\*(.+?)\*/g,'<em>$1</em>')
        .replace(/`(.+?)`/g,'<code>$1</code>')
        .replace(/\n/g,'<br>');
      return e;
    }

    // --- Export/Import ---
    $('#exportBtn').onclick = () => {
      const data = JSON.stringify(state, null, 2);
      const blob = new Blob([data], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'flybox_forum_export.json';
      a.click();
    }
    $('#importBtn').onclick = () => $('#importFile').click();
    $('#importFile').addEventListener('change', (e)=>{
      const file = e.target.files[0]; if(!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        try{
          const obj = JSON.parse(reader.result);
          if(!obj || !obj.cats || !obj.threads) throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–∞–π–ª');
          state = obj; save(state); route();
        }catch(err){ alert('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: '+err.message); }
      };
      reader.readAsText(file);
    });

    // --- Events ---
    $('#newThreadBtn').onclick = () => { fillCatSelect(); openModal(); };
    $('#cancelModal').onclick = closeModal;
    $('#createThread').onclick = () => {
      const title = $('#ntTitle').value.trim();
      const cat = $('#ntCategory').value; const author = $('#ntAuthor').value.trim() || '–ì–æ—Å—Ç—å';
      const content = $('#ntContent').value.trim();
      if(!title || !content) return alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ');
      state.threads.push({id:uid(), title, cat, author, created:nowISO(), content, replies:[]});
      save(state); closeModal(); navigate('/');
      // –æ—á–∏—Å—Ç–∏—Ç—å
      $('#ntTitle').value=''; $('#ntContent').value='';
    };

    $('#homeBtn').onclick = () => navigate('/');
    $('#search').addEventListener('input', ()=>route());
    $('#modKey').addEventListener('input', ()=>{ setModKey($('#modKey').value); });

    // init
    renderCats(); route();
  </script>
</body>
</html>
